#!/bin/bash

# Parse command-line options using getopt
ARGS=$(getopt -o hbH --long help,beamer,homework -- "$@")
eval set -- "$ARGS"

help="

Init LaTeX MWE (minimal working example) project in the current directory with
the required configuration files to work in the VsCode and the LaTeX workshop
extension.

USAGE:
  $(basename "$0") [FILE]
  $(basename "$0") [-b | -H] [--] [FILE]
  $(basename "$0") -h [--] [FILE]
ARGS:
  FILE
    Main LaTeX file name. If it already exists, just put the default preamble
    in it instead generating a MWE. The dafault name is main.tex.
OPTIONS:    
  -h, --help
    Show this help text
  -b, --beamer
    Download the Bearmer MWE instead.
  -H, --homework
    Download the homework MWE instead.
"

# Process the options and arguments
while true; do
  case "$1" in
    -h | --help)
      echo "$help"
      exit 0  # Exit after displaying help      ;;
      ;;
    -b | --beamer)
      mwe='https://gist.githubusercontent.com/tapyu/886dc95fc19c4250fb38581ccc58bed8/raw/beamer_mwe.tex'
      support=('https://gist.githubusercontent.com/tapyu/886dc95fc19c4250fb38581ccc58bed8/raw/beamer_class.cls')
      support_name=('beamer_class.cls')
      shift 2
      break
      ;;
    -H | --homework)
      mwe='https://gist.githubusercontent.com/tapyu/886dc95fc19c4250fb38581ccc58bed8/raw/homework_mwe.tex'
      support=('https://gist.githubusercontent.com/tapyu/886dc95fc19c4250fb38581ccc58bed8/raw/homework_commands.tex')
      support_name=('homework_commands.tex')
      shift 2
      break
      ;;
    --)
      shift
      break
      ;;
  esac
done

file="${1:-main.tex}"
# download Makefile
curl --insecure --silent https://gist.githubusercontent.com/tapyu/886dc95fc19c4250fb38581ccc58bed8/raw/make > Makefile
[[ "file" != "main.tex" ]] && sed -i "2s/main/${file%.tex}/" Makefile
# download .vscode/ config
[[ ! -d .vscode ]] && mkdir .vscode
curl --silent https://gist.githubusercontent.com/tapyu/886dc95fc19c4250fb38581ccc58bed8/raw/_vscode_makefile.json > .vscode/settings.json
# download default preamble
curl --insecure --silent https://gist.githubusercontent.com/tapyu/886dc95fc19c4250fb38581ccc58bed8/raw/_default_preamble.tex > default_preamble.tex
# download default glossary entries
curl --insecure --silent https://gist.githubusercontent.com/tapyu/886dc95fc19c4250fb38581ccc58bed8/raw/my_glossary_entries.tex > default_gossary_entries.tex
# if is a predefined MWE template, download it
if [[ -v mwe ]]; then
  curl --insecure --silent $mwe > "$file"
  # if the MWE has support files, download them
  if [[ -v support ]]; then
    for ((i=0; i<${#support[@]}; i++));do
      curl --insecure --silent ${support[i]} > ${support_name[i]}
    done
  fi
# if it is a generic MWE that already exists, insert \input{} statement
elif [[ -f "$file" ]]; then
  grep --quiet "\\input{default_preamble.tex}" "$file" || sed -i '2i\\\input{default_preamble.tex}\n' "$file"
# else, create a generic MWE template
else
	echo -e '\\documentclass{article}\n\\input{default_preamble.tex}\n\\begin{document}\n\tHello, world!\n\\end{document}' > "$file"
fi

# if it contains the default refs.bib file, add it to $file
if [[ -f "$HOME/.cache/zotero/refs.bib" && -z $(grep --only-matching 'refs.bib' abstract.tex) ]]; then
  ln -sf "$HOME/.cache/zotero/refs.bib" refs.bib
  sed -i '3i\\addbibresource{refs.bib}\' "$file"
  line=$(awk '/\\end{document}/ { print NR }' "$file")
  sed -i "${line}i\\\t\\\\printbibliography" "$file"
  sed -i 's|Hello, world!|& \\cite{jiaoCharacteristicsLowlatitudeSignal2014}|g' "$file"
fi
